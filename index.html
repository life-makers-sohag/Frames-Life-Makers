<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frame Life Makers — نهائي</title>
  <meta name="description" content="منصة احترافية لإنشاء الصور بإطارات مميزة مع تحكم كامل في النص والصورة." />

  <!-- Cairo font + Font Awesome -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Fabric.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>

  <style>
/* حاوية زر التحميل */
.download-wrapper {
    margin-top: 20px;
    text-align: center;
}

/* زر التحميل */
#downloadBtn {
    width: 80%;
    max-width: 350px;
    padding: 18px 20px;
    font-size: 18px;
    font-weight: 700;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #16a34a, #22c55e);
    color: #fff;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

/* تأثير Hover */
#downloadBtn:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
}

/* تأثير الضغط */
#downloadBtn:active {
    transform: scale(0.97);
}


    /* ================== RESET & THEME ================== */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#0f172a;--bg2:#1e293b;--primary:#3b82f6;--success:#16a34a;--danger:#dc2626;
      --glass:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--text-soft:rgba(255,255,255,.75)
    }
    body{font-family:'Cairo',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}

    /* Navbar */
    .navbar{display:flex;justify-content:space-between;align-items:center;padding:18px 32px;background:var(--glass);backdrop-filter: blur(12px);border-bottom:1px solid var(--border)}
    .logo{font-weight:800;font-size:18px;display:flex;gap:8px;align-items:center}
    .btn-outline{border:1px solid var(--border);background:transparent;color:#fff;padding:8px 14px;border-radius:999px;cursor:pointer}

    .app{max-width:1200px;margin:30px auto}
    .hero{text-align:center;padding:26px 12px}
    .hero h1{font-size:28px;background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero p{color:var(--text-soft);margin-top:6px}

    .main{display:grid;grid-template-columns:360px 1fr;gap:28px;padding:10px}

    /* Panel */
    .panel{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:18px;padding:20px}
    .panel-section{margin-bottom:18px}
    label{display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:#fff}
    .controls-row{display:flex;gap:8px}
    .controls-row button{flex:1}
    button.btn-primary{background:var(--primary);border:none}
    button.btn-secondary{background:#0ea5e9;border:none}
    button.btn-success{background:var(--success);border:none}
    button.btn-danger{background:var(--danger);border:none}

    .frames{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .frames img{width:100%;height:70px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid transparent}
    .frames img.selected{border-color:var(--primary)}

    /* Preview */
    .preview{display:flex;flex-direction:column;align-items:center}
    .canvas-wrap{width:100%;max-width:720px;padding:18px;border-radius:16px;background:#fff;box-shadow:0 30px 80px rgba(0,0,0,.6);position:relative}
    /* Force canvas visible & prevent accidental absolute positioning */
    .canvas-wrap { position: relative !important; }
    canvas#canvas { position: relative !important; display: block !important; width: 100% !important; height: 100% !important; border-radius:12px; background:#fff; }

    .loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);color:#fff;border-radius:12px}
    .hint{margin-top:12px;color:var(--text-soft)}
    .footer{text-align:center;padding:20px;color:var(--text-soft);margin-top:22px}
    .developer{color:#60a5fa;font-weight:700}

    .floating-whatsapp{position:fixed;bottom:28px;left:28px;background:#25D366;color:#fff;font-size:20px;padding:14px;border-radius:50%;box-shadow:0 18px 45px rgba(0,0,0,.6)}
    @media(max-width:980px){.main{grid-template-columns:1fr}.frames img{height:60px}}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo"><i class="fa-solid fa-image"></i> Frame Life Makers</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="resetAll" class="btn-outline"><i class="fa-solid fa-rotate"></i> إعادة تعيين</button>
    </div>
  </nav>

  <div class="app">
    <header class="hero"><h1>كل سنة وانت طيب يا صنعاوي</h1><p>اختر الإطار، ارفع صورتك، وحرّك النص والصورة كما تريد</p></header>

    <div class="main">
      <aside class="panel">
        <section class="panel-section">
          <h3><i class="fas fa-images"></i> اختر الإطار</h3>
          <div class="frames" id="framesContainer" aria-hidden="false"></div>
          <small style="color:var(--text-soft);display:block;margin-top:8px">الإطار يظهر أعلى الصورة (غير قابل للتحريك)</small>
        </section>

        <section class="panel-section">
          <h3><i class="fas fa-upload"></i> رفع الصورة</h3>
          <input type="file" id="upload" accept="image/*">
          <button id="previewBtn" class="btn-primary" style="margin-top:8px"><i class="fas fa-play"></i> تطبيق الصورة</button>
        </section>

        <section class="panel-section">
          <h3><i class="fas fa-edit"></i> تحكم الصورة</h3>
          <label>تكبير الصورة: <span id="zoomPercent">100%</span></label>
          <input type="range" id="zoomSlider" min="10" max="300" value="100">
          <div class="controls-row" style="margin-top:8px">
            <button id="zoomInBtn">+</button>
            <button id="zoomOutBtn">-</button>
            <button id="rotateLeftBtn">⟲</button>
            <button id="rotateRightBtn">⟳</button>
            <button id="resetBtn">⟲↺</button>
          </div>
        </section>

        <section class="panel-section">
          <h3><i class="fas fa-font"></i> إدارة النصوص</h3>
          <input type="text" id="username" placeholder="اكتب النص هنا">
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="fontFamily"><option value="Cairo">Cairo</option><option value="Arial">Arial</option></select>
            <input type="range" id="fontSize" min="12" max="120" value="40" style="flex:1">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input type="color" id="fontColor" value="#000000" style="width:54px;padding:6px">
            <label style="align-items:center;display:flex;gap:6px"><input type="checkbox" id="textBold"> عريض</label>
            <label style="align-items:center;display:flex;gap:6px"><input type="checkbox" id="textItalic"> مائل</label>
            <label style="align-items:center;display:flex;gap:6px"><input type="checkbox" id="textUnderline"> تسطير</label>
          </div>

          <div class="controls-row" style="margin-top:8px">
            <button id="addNameBtn" class="btn-secondary">إضافة نص</button>
            <button id="updateTextBtn" class="btn-primary">تحديث</button>
            <button id="deleteTextBtn" class="btn-danger">حذف</button>
          </div>

          <small style="color:var(--text-soft);display:block;margin-top:8px">انقر على النص داخل المعاينة لاختياره أو لسحبه وتغيير حجمه.</small>
        </section>

                <section class="panel-section">
            <h3>جودة التحميل</h3>
            <select id="exportQuality">
                <option value="1">عادية</option>
                <option value="2" selected>عالية</option>
                <option value="3">عالية جداً</option>
            </select>

            <div class="download-wrapper">
                <button id="downloadBtn">
                    <i class="fas fa-download"></i> تحميل الصورة
                </button>
            </div>
        </section>
        
          
          
          <!-- <button id="downloadBtn" class="btn-success" style="width:auto;margin-left:8px"><i class="fas fa-download"></i> تحميل</button> -->

        <!-- </section> -->

      </aside>

      <section class="preview">
        <div class="canvas-wrap">
          <div id="loader" class="loader" style="display:none"><i class="fas fa-spinner fa-spin"></i> جاري المعالجة...</div>
          <canvas id="canvas" width="800" height="800" aria-label="منصة المعاينة"></canvas>
        </div>
        <p class="hint">اسحب الصورة أو النص لتغيير موضعهما — استخدم عجلة الفأرة للتكبير/التصغير داخل الكانفاس</p>
      </section>
    </div>

    <footer class="footer">تم إنشاء الموقع بواسطة <span class="developer">محمود حامد</span></footer>
    <a href="https://wa.me/201004959936" class="floating-whatsapp" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>
  </div>

  <script>
  /**
   * ملاحظات مهمة قبل التشغيل:
   * - ضع مجلد frames/ في نفس مسار هذا الملف.
   * - داخل frames/ أنشئ ملف frames.json مثلاً:
   *     ["frame1.png","frame2.png","frame3.png"]
   *   وضع الصور المذكورة داخل مجلد frames/.
   *
   * هذا الكود يقوم ب:
   * - تحميل قائمة الإطارات من frames/frames.json أو استخدام قائمة احتياطية.
   * - تطبيق الإطار كـ overlay غير قابل للتحريك.
   * - رفع صورة المستخدم وعرضها فوراً (مع إصلاح مشاكل offset/position التي قد تظهر عند فتح F12).
   */

  document.addEventListener('DOMContentLoaded', function(){
    // ============= INIT =================
    const canvas = new fabric.Canvas('canvas', { preserveObjectStacking: true, selection: true, backgroundColor: '#ffffff' });
    let userImage = null;
    let frameOverlay = null;
    let activeText = null;

    // DOM
    const framesContainer = document.getElementById('framesContainer');
    const uploadInput = document.getElementById('upload');
    const previewBtn = document.getElementById('previewBtn');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomPercent = document.getElementById('zoomPercent');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resetAllBtn = document.getElementById('resetAll');
    const loader = document.getElementById('loader');

    const usernameInput = document.getElementById('username');
    const addNameBtn = document.getElementById('addNameBtn');
    const updateTextBtn = document.getElementById('updateTextBtn');
    const deleteTextBtn = document.getElementById('deleteTextBtn');
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const fontColor = document.getElementById('fontColor');
    const textBold = document.getElementById('textBold');
    const textItalic = document.getElementById('textItalic');
    const textUnderline = document.getElementById('textUnderline');
    const exportQuality = document.getElementById('exportQuality');

    // ============= RESIZE CANVAS =============
    function resizeCanvasToContainer(){
      const wrap = document.querySelector('.canvas-wrap');
      const width = Math.min(wrap.clientWidth - 36, 800);
      canvas.setWidth(width);
      canvas.setHeight(width);
      canvas.calcOffset && canvas.calcOffset();
      // adjust frame overlay if exists
      if(frameOverlay){
        frameOverlay.scaleToWidth(canvas.getWidth());
        frameOverlay.set({ left: canvas.getWidth()/2, top: canvas.getHeight()/2, originX:'center', originY:'center' });
      }
      // adjust user image center if present
      if(userImage){
        userImage.set({ left: canvas.getWidth()/2, top: canvas.getHeight()/2, originX:'center', originY:'center' });
        // keep its scale but ensure it fits inside
        const maxW = canvas.getWidth() - 40;
        const maxH = canvas.getHeight() - 40;
        const scale = Math.min(maxW / (userImage.width || 1), maxH / (userImage.height || 1), userImage.scaleX || 1);
        userImage.scale(scale);
      }
      canvas.renderAll();
    }
    window.addEventListener('resize', resizeCanvasToContainer);
    resizeCanvasToContainer();

    // loader helpers
    function showLoader(){ loader.style.display = 'flex'; }
    function hideLoader(){ loader.style.display = 'none'; }

    // ============= LOAD FRAMES FROM frames/frames.json OR FALLBACK ===========
    async function loadFrames(){
      framesContainer.innerHTML = '';
      let list = null;
      try {
        const res = await fetch('frames/frames.json', { cache: 'no-store' });
        if(res.ok) list = await res.json();
      } catch(e){
        console.warn('frames.json not found or failed to load', e);
      }
      if(!list) {
        // fallback - عدل هذه الأسماء لتتناسب مع ملفاتك داخل frames/
        list = ['frame1.png','frame2.png','frame3.png'];
      }
      list.forEach((filename, idx) => {
        const src = `frames/${filename}`;
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Frame ' + (idx+1);
        img.tabIndex = 0;
        img.addEventListener('click', ()=> {
          framesContainer.querySelectorAll('img').forEach(i=>i.classList.remove('selected'));
          img.classList.add('selected');
          applyFrame(src);
        });
        img.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') img.click(); });
        framesContainer.appendChild(img);
      });

      // auto-select first frame if exists
      const first = framesContainer.querySelector('img');
      if(first) {
        first.classList.add('selected');
        applyFrame(first.src);
      }
    }

    // applyFrame: load image and place as non-selectable overlay on top
    function applyFrame(src){
      // add cache-buster to ensure fresh load when you edit frames
      const url = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
      fabric.Image.fromURL(url, function(img){
        img.set({ originX:'center', originY:'center', left: canvas.getWidth()/2, top: canvas.getHeight()/2, selectable:false, evented:false });
        img.scaleToWidth(canvas.getWidth());
        if(frameOverlay){ try{ canvas.remove(frameOverlay); }catch(e){} frameOverlay = null; }
        frameOverlay = img;
        canvas.add(frameOverlay);
        canvas.bringToFront(frameOverlay);
        // ensure visible (fix when DevTools forced layout change)
        resizeCanvasToContainer();
        canvas.calcOffset && canvas.calcOffset();
        canvas.renderAll();
      }, { crossOrigin: 'anonymous' });
    }

    // ============= IMAGE UPLOAD & PREVIEW (مباشر - يصلح مشكلة ظهور بعد F12) ============
    previewBtn.addEventListener('click', ()=> {
      const file = uploadInput.files[0];
      if(!file) return alert('اختر صورة أولاً');
      const reader = new FileReader();
      showLoader();
      reader.onload = function(e){
        fabric.Image.fromURL(e.target.result, function(img){
          // remove all except frameOverlay
          canvas.getObjects().slice().forEach(o => { if(o !== frameOverlay) canvas.remove(o); });

          img.set({ originX:'center', originY:'center', left: canvas.getWidth()/2, top: canvas.getHeight()/2 });
          const maxW = canvas.getWidth() - 40;
          const maxH = canvas.getHeight() - 40;
          const scale = Math.min(maxW / img.width, maxH / img.height, 1);
          img.scale(scale);
          img.setControlsVisibility({mt:true,mb:true,ml:true,mr:true,tl:true,tr:true,bl:true,br:true});

          userImage = img;
          canvas.add(img);
          canvas.setActiveObject(img);

          // مهم: إعادة حساب offsets وforced layout لمنع مشكلة الظهور بعد فتح F12
          resizeCanvasToContainer();
          canvas.calcOffset && canvas.calcOffset();

          zoomSlider.value = Math.round((img.scaleX || 1) * 100);
          zoomPercent.textContent = zoomSlider.value + '%';

          // force canvas element styles as backup
          const canv = document.getElementById('canvas');
          if(canv){ canv.style.position = 'relative'; canv.style.display = 'block'; }

          canvas.renderAll();
          hideLoader();
        }, { crossOrigin: 'anonymous' });
      };
      reader.readAsDataURL(file);
    });

    // ============= ZOOM CONTROLS =============
    zoomSlider.addEventListener('input', ()=> {
      if(!userImage) return;
      const val = parseInt(zoomSlider.value,10)/100;
      userImage.scale(val);
      canvas.renderAll();
      zoomPercent.textContent = zoomSlider.value + '%';
    });
    document.getElementById('zoomInBtn').addEventListener('click', ()=>{ zoomSlider.value = Math.min(300, parseInt(zoomSlider.value)+10); zoomSlider.dispatchEvent(new Event('input')); });
    document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ zoomSlider.value = Math.max(10, parseInt(zoomSlider.value)-10); zoomSlider.dispatchEvent(new Event('input')); });

    // rotate
    document.getElementById('rotateLeftBtn').addEventListener('click', ()=>{ if(userImage){ userImage.rotate((userImage.angle||0)-15); canvas.renderAll(); } });
    document.getElementById('rotateRightBtn').addEventListener('click', ()=>{ if(userImage){ userImage.rotate((userImage.angle||0)+15); canvas.renderAll(); } });

    // reset image transform
    resetBtn.addEventListener('click', ()=> {
      if(userImage){
        userImage.set({ left: canvas.getWidth()/2, top: canvas.getHeight()/2, scaleX:1, scaleY:1, angle:0, originX:'center', originY:'center' });
        canvas.renderAll();
        zoomSlider.value = 100; zoomPercent.textContent = '100%';
      }
    });

    // ============= TEXT CONTROLS =============
    addNameBtn.addEventListener('click', ()=> {
      const text = usernameInput.value.trim();
      if(!text) return alert('اكتب نصاً أولاً');
      const it = new fabric.IText(text, {
        left: canvas.getWidth()/2,
        top: canvas.getHeight()/2,
        originX:'center', originY:'center',
        fontFamily: fontFamily.value,
        fontSize: parseInt(fontSize.value,10),
        fill: fontColor.value,
        fontWeight: textBold.checked ? 'bold' : 'normal',
        fontStyle: textItalic.checked ? 'italic' : 'normal',
        underline: textUnderline.checked,
        selectable: true
      });
      canvas.add(it);
      canvas.setActiveObject(it);
      activeText = it;
      canvas.renderAll();
    });

    function applyTextControlsToActive(){
      if(!activeText) return;
      activeText.set({
        text: usernameInput.value,
        fontFamily: fontFamily.value,
        fontSize: parseInt(fontSize.value,10),
        fill: fontColor.value,
        fontWeight: textBold.checked ? 'bold' : 'normal',
        fontStyle: textItalic.checked ? 'italic' : 'normal',
        underline: textUnderline.checked
      });
      canvas.renderAll();
    }
    updateTextBtn.addEventListener('click', applyTextControlsToActive);
    deleteTextBtn.addEventListener('click', ()=>{ if(activeText){ canvas.remove(activeText); activeText = null; canvas.discardActiveObject(); canvas.renderAll(); } });

    // selection sync
    canvas.on('selection:created', (e)=>{ handleSelection(e.target || (e.selected && e.selected[0])); });
    canvas.on('selection:updated', (e)=>{ handleSelection(e.target || (e.selected && e.selected[0])); });
    canvas.on('selection:cleared', ()=>{ activeText = null; });

    function handleSelection(obj){
      if(!obj || obj === frameOverlay) return;
      if(obj.type === 'i-text' || obj.type === 'textbox' || obj.type === 'text'){
        activeText = obj;
        usernameInput.value = obj.text || '';
        fontFamily.value = obj.fontFamily || 'Cairo';
        fontSize.value = obj.fontSize || 40;
        fontColor.value = obj.fill || '#000000';
        textBold.checked = (obj.fontWeight === 'bold');
        textItalic.checked = (obj.fontStyle === 'italic');
        textUnderline.checked = !!obj.underline;
      } else if(obj.type === 'image'){
        userImage = obj;
        zoomSlider.value = Math.round((obj.scaleX || 1) * 100);
        zoomPercent.textContent = zoomSlider.value + '%';
      }
    }

    // delete key
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Delete' || e.key === 'Backspace'){ const o = canvas.getActiveObject(); if(o && o !== frameOverlay){ canvas.remove(o); canvas.discardActiveObject(); activeText = null; canvas.renderAll(); } } });

    // ============= DOWNLOAD =============
    downloadBtn.addEventListener('click', ()=> {
      canvas.discardActiveObject(); canvas.renderAll();
      showLoader();
      setTimeout(()=> {
        const multiplier = parseInt(exportQuality.value,10);
        const dataURL = canvas.toDataURL({ format: 'png', multiplier: multiplier });
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `Frame-Life-Makers-${new Date().toISOString().slice(0,10)}.png`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        hideLoader();
      }, 200);
    });

    // ============= RESET ALL =============
    resetAllBtn.addEventListener('click', ()=> {
      canvas.getObjects().slice().forEach(o => canvas.remove(o));
      userImage = null; activeText = null; frameOverlay = null;
      canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
      framesContainer.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
    });

    // keep frame on top
    canvas.on('object:moving', ()=>{ if(frameOverlay) canvas.bringToFront(frameOverlay); });
    canvas.on('object:scaling', ()=>{ if(frameOverlay) canvas.bringToFront(frameOverlay); });

    // initial load frames
    loadFrames();

    // final ensure
    resizeCanvasToContainer();
    canvas.calcOffset && canvas.calcOffset();
  });
  </script>
</body>
</html>
